---
title: "Douglas-complex fire smoke and cardiopulmonary morbidity"
author: "Ryan Gan"
date: "11/3/2017"
output: html_document
---

##1. Introduction

In the summer of 2013, the Douglas-Complex fires occured in southwest Oregon. Oregonians in this part of the state were at risk of exposure to extreme levels of particulate matter (PM). This project aim is to determine if there is an association to smoke from the Douglas-Complex fires and acute cardiopulmonary morbidity in the state of Oregon.

Data came from the Oregon All Payer All Claims Database (APAC) in the year 2013. The APAC records the health care billing data for Oregon's insured populations. APAC include individual billing records for both diagnoses codes (International Classification of Diseases, Clinical Modification (ICD-9-CM) diagnoses codes) and pharmacy codes (National Drug Codes (NDC)). 

Our previous research that found an association with wildfire smoke and respiratory outcomes in Washington state in 2012 wildfire season using a novel estimate of smoke concentration, geographically weighted ridge regression (GWR) guided the methodological approaches used in this project. As Oregon contains pharmacy records, we evaluate the association between smoke and respiratory rescue medications (beta 2 agonists) (abbreviate to SABA). 

*Research question*
We evaluated the association between smoke concentrations using the GWR method and cardiopulmonary morbidity, including ED/urgent care visits and SABA fills in Oregon state during the 2013 wildfire season.

This markdown document contains the code and results that were used to address this research question.

**Note to Jingyang 11/3/17: I saw all the packages you used. How many do you actually need to run these analyses? It also looks like you need to run this markdown file on the server? I would like to avoid that and I can help you do this.**

Packages used: tidyverse
```{r setup}
library(tidyverse)
```

##2. Wildfire smoke descriptive characteristics
Import PM~2.5~ data.

Map of smoke count and smoke time series will go here.

##3. Descriptive table of number of health outcomes

Importing casecross over dataframes.
**Note to Jingyang 11/3/17: Same issue as above. How many of these files needs to be uploaded to produce results? A lot of this seems redundant or inefficient. I cannot find a lot of outcome files I need. I also need the SABA casecrossover dataframe. Listing example of two casecross over dataframes for now. Let's talk about this.**

```{r health data import, message=F, warning=F}
# importing case-crossover dataframes 
# SABA case-crossover will be imported first
# i can't find a lot of the files
#resp_path <- paste0("./"

# asthma
asthma_path <- paste0("../../data/health/2017-oregon_casecross_asthma.csv")
asthma_df <- read_csv(asthma_path)

# cvd 
cvd_path <- paste0("../../data/health/2017-oregon_casecross_cvd.csv")
cvd_df <- read_csv(cvd_path)
# had a warning message for cvd dataframe import; should check on this

# import all other dataframes

# I think purrr would be a good way to loop through a list of outcome dataframes
# bind dataframes in a list
outcome_df_list <- list(asthma_df, cvd_df)

# name list elements in order I'd like to present in document
outcome_names <- c("SABA", "Respiratory", "Asthma", "COPD", "Pneumonia", 
  "Acute Bronchitis", "Cardiovascular Disease", "Arrhythmia", 
  "Cerebrovascular Disease", "Heart Failure", "Ischemic Heart Disease", 
  "Myocardial Infarction")

names(outcome_df_list) <- c( 'Asthma', 'CVD')
```

CVD warning message on import. Have Jingyang check. Maybe why proportion of CVD vs respiratory so different in Oregon?
*Warning message:In rbind(names(probs), probs_f) :number of columns of result is not a multiple of vector length (arg 1)*

Descriptive table will go here. Jingyang, I'll have you add the other dataframes to analyze. I provided an example of Asthma and CVD. 

```{r descriptive table}
# creating a row calculation function
table1_fun <- function(data_list){
  # output of total n
  total_n <- data_list %>% 
    filter(outcome == 1) %>%
    summarise(total_n = n())
  
  # output row of summary numbers
  age_cat_n <- data_list %>% 
    filter(outcome == 1) %>%
    group_by(age_ind) %>% 
    summarise(n = n()) %>%
    mutate(age_cat = ifelse(age_ind == 0, "age_under15",
                      ifelse(age_ind == 1, "age_15to65", "age_over65")),
           # preserve factor order
           age_cat = parse_factor(age_cat, levels = age_cat)) %>% 
    select(-age_ind) %>% 
    spread(age_cat, n)
  # sex n
  sex_n <- data_list %>% 
    filter(outcome == 1) %>% 
    group_by(gender) %>% 
    summarise(n = n()) %>% 
    filter(gender != "U") %>% 
    spread(gender, n)
  # bind all rows together
  outcome_n_row <- bind_cols(total_n, age_cat_n, sex_n) %>% 
    mutate(perc_15 = round(age_under15/total_n,2), 
           perc_15to65 = round(age_15to65/total_n,2),
           perc_65 = round(age_over65/total_n,2),
           perc_F = round(F/total_n,2),
           perc_M = round(M/total_n,2)) %>% 
    select(total_n, age_under15, perc_15, age_15to65, perc_15to65, 
           age_over65, perc_65, F, perc_F, M, perc_M)
return(outcome_n_row)
} # end function

# outcome names
outcome_names <- names(outcome_df_list) %>% 
  data_frame() %>% 
  rename(outcome = ".")

# apply custom function to generate descriptive table
table_vals <- outcome_df_list %>% 
  # map to dataframe
  map_dfr(table1_fun) 
# descriptive table, bind outcome names and values
descriptive_table <- bind_cols(outcome_names, table_vals)

# output table
knitr::kable(descriptive_table, 
  caption = "Descriptive charactersitics of ED/urgent care visits")
```

##4. Distributed lag cumulative effect results

##5. Distributed lag results

##6. Stratified cumulative results

##7. SABA cumulative effect by underlying respiratory diagnosis


### Comments:
1. File structure needs to be cleaned up. There are way too many subdirectories.
2. Remove r code files that are not useful. There are too many files with similar code inside.
3. Variables in the casecross over datasets raise some questions. For example, what is the difference from the varialbes geo_smk_pm and 


