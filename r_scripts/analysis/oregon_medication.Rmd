---
title: "Oregon 2013 Medication for Asthma Inhalers"
author: "Jingyang Liu"
date: "May 17, 2017"
output: html_document
---

```{r library, include=FALSE, echo=FALSE}
library(dplyr)
library(data.table)
library(readxl) 
library(readr)
library(survival)
library(ggplot2)
library(htmlTable)
```


## Overview
For this research I have the Oregon All Payer All Claims (APAC) data set in 2013. I want to research on the effects of wildfire smoke on pharmacy outcome of asthma. NDC (National Drug Code) is the code that the data set offered. The standard NDC I use the link below, which is a ndc list in 2013, which fits my original data set. 
(http://ww2.ncqa.org/hedis-quality-measurement/hedis-measures/hedis-2013/hedis-2013-final-ndc-lists)

The data cleaning and casecrossover study are huge computation tasks, so they are done with server, the following work is done with local R.


## Method Description

In these comparisons, we examine various methods of smoke PM2.5 estimations and associations with health outcomes using a time-stratified case-crossover study design. Pharmacy outcomes for a patient with a primary diagnosis of cardiopulmonary health outcomes and their date of admission (index time) were identified. We then created counterfactual observations for each patient on the same day of the week for the entire wildfire season (May 1st to Sep 30th, 2013). For patients who have a index time before May 1, 2013 or after September 30, 2013, their referent observations before or after these dates will be excluded as I will not be able to assign estimates of PM2.5 to these referent observations.

1. Data cleaning for health outcomes

There are about 77 million claims in the total data set. Some have the NDC but another are null or missing because people are going for pharmacy or seeing the doctor. So I choose the claims in Oregon State with ndc existing, which is about 23 million claims. Also, the POS (Place of service code) all show "pharmacy" type, comparing to the previous health disease outcomes we limit the "emergency visit" type or "urgent care" type.

For ndc, I choose the people who use the beta 2 agonists (one inhaler) for the day's first visit to form the sample. Because the ndc csv file has more information than what I need, I filter the ndc file by SQLite Studio (code and steps not attached) to a file only containing the beta 2 agonists medication information. 

After choosing the claims with beta 2 agonists, the data set is reduced to 232,665. After choosing people's each day's first visit and limit the wildfire season dates (May 1st, 2013 to September 30th, 2013), the data set is the final data set we research on, containing  only 24,538 claims.

2. Exposure methods for smoke model

In this research, we focus on the GWR method (geographically weighted ridge regression). There are also WRF-Chem model (which substracts WRF-chem from the Weather Research and Forecasting with Chemistry no fire emission). For the WRF-Chem variable with the 'smoke' designator, this is WRF-Chem - WRF-Chem no fire. For Geo-Weighted Regression and Kriging model, with 'smk' designator, I subtracted off the 'Background' estimates of smoke, which I believe are the monthly averages of PM2.5 for a given grid. However, the 'Background' is the mean of total period from May 1st to Sep 30th 2013 so I have to assign the mean for every day. To reduce the occurance error and compare the differences I will analyze all three models.

3. Analytic method

We use the conditional logistic regression model using the survival package in R. Each conditional logistic regression model accounts for the subject, and adjusts for temperature from the WRF-Chem model. The conditional logistic regression model \beta represents the change in risk of an pharmacy event associated with a short-term unit increase in exposure, and can be calculated as an average difference between exposure at the index time and a weighted average of exposure at all times in the referent window. 

```{r import original data, eval=FALSE, echo=FALSE}
### Import whole data set ------------------------------------------------------
read_path <- paste0("../../../data/data_original/gan_episodes_of_care.txt")
start_time <- Sys.time()
oregon_df <- fread(read_path, sep = "|", showProgress = T) 
stop_time <-  Sys.time() - start_time 
# time it took
stop_time # 7 mins

## Basic cleaning
start_time <- Sys.time()
oregon_df2 <- oregon_df %>% 
  filter((!ndc=="")&(!ndc=="*NULL*")) %>% 
  # filter State is Oregon
  filter(STATE=="OR")
stop_time <-  Sys.time() - start_time 
# time it took
stop_time # 40 secs

write_path <- paste0('../../../data/data_new/',
                     'oregon_ndc.csv')
write_csv(oregon_df2, write_path)
```


```{r import original data, eval=FALSE, echo=FALSE}
### Import whole data set ------------------------------------------------------
read_path <- paste0("../../../data/data_original/gan_episodes_of_care.txt")
start_time <- Sys.time()
oregon_df <- fread(read_path, sep = "|", showProgress = T) 
stop_time <-  Sys.time() - start_time 
# time it took
stop_time # 7 mins

### Import NDC data set --------------------------------------------------------
read_path <- paste0("../../../data/data_new/oregon_ndc.csv")
oregon_ndc <- read_csv(read_path)
dim(oregon_ndc) # 23330714 obs

## Import Asthma NDC table
read_path2 <- paste0("../../../data/data_new/ndc_2013_beta_2_agonists.csv")
asthma_ndc <- read_csv(read_path2, col_names = FALSE)

colnames(asthma_ndc) <- c("ndc_code", "brand_name", "generic_product_name", 
                          "route", "category", "drug_id")

# convert to vector
ndc_codes <- as.vector(as.matrix(asthma_ndc$ndc_code))

oregon_asthma <- oregon_ndc %>%
  filter(ndc %in% ndc_codes) # 232665, unique personkey 83787

oregon_asthma_df <- oregon_asthma %>% 
  group_by(personkey) %>% 
  arrange(personkey, fromdate, line) %>% 
  mutate(num_visit = dense_rank(fromdate)) %>%
  arrange(personkey, num_visit) %>% 
  select(personkey, clmid, num_visit) %>% 
  unique() %>% 
  full_join(oregon_asthma, by = c("personkey", "clmid")) %>% 
  arrange(personkey, clmid, line, fromdate) %>% 
  filter(row_number() == 1) %>%
  # add new transverted from date
  mutate(dates = as.Date(fromdate, "%m/%d/%Y")) # 83787 (same)


oregon_df_ndc <- oregon_df %>%
  filter(personkey %in% oregon_asthma$personkey) # 8909892

### Import ICD9 code
icd9_key <- read_excel("../../../data/data_original/CMS32_DESC_LONG_SHORT_DX.xlsx") %>% 
  # rename the terrible variable names
  select(dx_code = 1, long_desc = 2, short_desc = 3)

# sort by icd9 code add row variable 
icd9_key$X <- NULL
icd9_key <- arrange(icd9_key, dx_code) %>%
  mutate(n = as.numeric(row.names(icd9_key)))

### asthma
which(icd9_key$dx_code == '49300') # start of asthma is row 5206
which(icd9_key$dx_code == '49392') # end of asthma is row 5219

# limit just to asthma code and just the diagnosis column
icd9_check <- icd9_key %>%
  filter(n >= 5206 & n <= 5219) 
icd9_check

asthma_icd9 <- filter(icd9_key, n >= 5206 & n <= 5219) %>%
  select(dx_code)
# convert to vector
asthma_icd9 <- as.vector(as.matrix(asthma_icd9))   

# now can I make a new variable, asthma1, that indicates an asthma claim?
or_ndc_asthma_df <- oregon_df_ndc %>%
  filter(dx1 %in% asthma_icd9 |
         dx2 %in% asthma_icd9 |
         dx3 %in% asthma_icd9 |
         dx4 %in% asthma_icd9 |
         dx5 %in% asthma_icd9 |
         dx6 %in% asthma_icd9 |
         dx7 %in% asthma_icd9 |
         dx8 %in% asthma_icd9 |
         dx9 %in% asthma_icd9 |
         dx10 %in% asthma_icd9 |
         dx11 %in% asthma_icd9 |
         dx12 %in% asthma_icd9 |
         dx13 %in% asthma_icd9) # 375451


### COPD
copd_icd9 <- c('490', '4910','4911','49120','49121','49122','4918','4919', '4920',
               '4928', '4940', '4941', '496') 

# now can I make a new variable, asthma1, that indicates an asthma claim?
or_ndc_copd_df <- oregon_df_ndc %>%
  filter(dx1 %in% copd_icd9 |
         dx2 %in% copd_icd9 |
         dx3 %in% copd_icd9 |
         dx4 %in% copd_icd9 |
         dx5 %in% copd_icd9 |
         dx6 %in% copd_icd9 |
         dx7 %in% copd_icd9 |
         dx8 %in% copd_icd9 |
         dx9 %in% copd_icd9 |
         dx10 %in% copd_icd9 |
         dx11 %in% copd_icd9 |
         dx12 %in% copd_icd9 |
         dx13 %in% copd_icd9) # 361738


or_ndc_asthma_copd <- oregon_df_ndc %>%
  filter(dx1 %in% asthma_icd9 |
         dx2 %in% asthma_icd9 |
         dx3 %in% asthma_icd9 |
         dx4 %in% asthma_icd9 |
         dx5 %in% asthma_icd9 |
         dx6 %in% asthma_icd9 |
         dx7 %in% asthma_icd9 |
         dx8 %in% asthma_icd9 |
         dx9 %in% asthma_icd9 |
         dx10 %in% asthma_icd9 |
         dx11 %in% asthma_icd9 |
         dx12 %in% asthma_icd9 |
         dx13 %in% asthma_icd9 |
         dx1 %in% copd_icd9 |
         dx2 %in% copd_icd9 |
         dx3 %in% copd_icd9 |
         dx4 %in% copd_icd9 |
         dx5 %in% copd_icd9 |
         dx6 %in% copd_icd9 |
         dx7 %in% copd_icd9 |
         dx8 %in% copd_icd9 |
         dx9 %in% copd_icd9 |
         dx10 %in% copd_icd9 |
         dx11 %in% copd_icd9 |
         dx12 %in% copd_icd9 | 
         dx13 %in% copd_icd9) # 722107 

or_ndc_asthma_copd_sum <- or_ndc_asthma_copd %>%
  mutate(asthma1 = ifelse(dx1 %in% asthma_icd9, 1, 0),
         asthma2 = ifelse(dx2 %in% asthma_icd9, 1, 0),
         asthma3 = ifelse(dx3 %in% asthma_icd9, 1, 0),
         asthma4 = ifelse(dx4 %in% asthma_icd9, 1, 0),
         asthma5 = ifelse(dx5 %in% asthma_icd9, 1, 0),
         asthma6 = ifelse(dx6 %in% asthma_icd9, 1, 0),
         asthma7 = ifelse(dx7 %in% asthma_icd9, 1, 0),
         asthma8 = ifelse(dx8 %in% asthma_icd9, 1, 0),
         asthma9 = ifelse(dx9 %in% asthma_icd9, 1, 0),
         asthma10 = ifelse(dx10 %in% asthma_icd9, 1, 0),
         asthma11 = ifelse(dx11 %in% asthma_icd9, 1, 0),
         asthma12 = ifelse(dx12 %in% asthma_icd9, 1, 0),
         asthma13 = ifelse(dx13 %in% asthma_icd9, 1, 0),
         # sum up the asthma indicators
         asthma_sum = (asthma1 + asthma2 + asthma3 + asthma4 + asthma5 + asthma6 + asthma7 + asthma8 + asthma9 + asthma10 + asthma11 + asthma12 + asthma13),
         asthma_dx = ifelse(asthma_sum>0, asthma_sum, 0)
         ) %>% # end of mutate asthma
  mutate(copd1 = ifelse(dx1 %in% copd_icd9, 1, 0),
         copd2 = ifelse(dx2 %in% copd_icd9, 1, 0),
         copd3 = ifelse(dx3 %in% copd_icd9, 1, 0),
         copd4 = ifelse(dx4 %in% copd_icd9, 1, 0),
         copd5 = ifelse(dx5 %in% copd_icd9, 1, 0),
         copd6 = ifelse(dx6 %in% copd_icd9, 1, 0),
         copd7 = ifelse(dx7 %in% copd_icd9, 1, 0),
         copd8 = ifelse(dx8 %in% copd_icd9, 1, 0),
         copd9 = ifelse(dx9 %in% copd_icd9, 1, 0),
         copd10 = ifelse(dx10 %in% copd_icd9, 1, 0),
         copd11 = ifelse(dx11 %in% copd_icd9, 1, 0),
         copd12 = ifelse(dx12 %in% copd_icd9, 1, 0),
         copd13 = ifelse(dx13 %in% copd_icd9, 1, 0),
         # sum up the pneumonia indicators
         copd_sum = (copd1 + copd2 + copd3 + copd4 +copd5 + copd6 + copd7 + copd8 + copd9 +copd10 + copd11 + copd12 + copd13),
         copd_dx = ifelse(copd_sum>0, copd_sum, 0)
  ) %>% #end of mutate of copd
  select(-c(73:85), c(88:100))

or_index <- or_ndc_asthma_copd_sum %>%
  mutate(index = ifelse(asthma_dx > copd_dx, "asthma", 
                 ifelse(asthma_dx < copd_dx, "copd", 
                 ifelse(asthma_dx == copd_dx, "both", NA)))) # 56512 unique personkey
# asthma   both   copd
# 360631  14152 347324

write_path <- paste0('../../../data/data_new/',
                     'oregon_index.csv')
write_csv(or_index, write_path)



```



```{r choose ndc, eval=FALSE, echo=FALSE}


# limit to the unique personkey different days' first visit
oregon_asthma_df <- oregon_asthma %>% 
  group_by(personkey) %>% 
  arrange(personkey, fromdate, line) %>% 
  mutate(num_visit = dense_rank(fromdate)) %>%
  arrange(personkey, num_visit) %>% 
  select(personkey, clmid, num_visit) %>% 
  unique() %>% 
  full_join(oregon_asthma, by = c("personkey", "clmid")) %>% 
  arrange(personkey, clmid, line, fromdate) %>% 
  filter(row_number() == 1) %>%
  # add new transverted from date
  mutate(dates = as.Date(fromdate, "%m/%d/%Y")) %>%
  filter(dates >= '2013-05-01' & 
         dates <= '2013-09-30') # 24538

write_path2 <- paste0("../../../data/data_new/oregon_asthma_ndc.csv")
write_csv(oregon_asthma_df, write_path2)

```

## Time-Stratified Case-Crossover (Population-Weighted PM~2.5~ Assigned by Zip Code)
*referents same day of week within fire season May - September*
 
Because we want the I also make the counterfactual dates for each claim, which means that for each claim, I choose the day the claim shows, to indicate the outcome for this day is "1". Then I make the dates week by week before this date, and after this date in the whole wildfire season, and indicate these dates' outcomes are "0". Then I can use these outcomes for the following model building.


```{r casecrossover, eval=FALSE, echo=FALSE}
### Casecrossover study
read_path3 <- paste0("../../../data/data_new/medication/oregon_asthma_ndc.csv")
oregon_asthma_df <- read_csv(read_path3)


outcome_id <- oregon_asthma_df %>%
  # arrange with dates
  arrange(dates) %>%
  mutate(id = seq(1, nrow(.), by = 1))

# create dataset to populate
id_date_df <- data_frame()


# begin second loop to create counterfactual observations for each case subject
for (k in 1:nrow(outcome_id)){
  
  # find the replicate times of weeks
  dates_l <- outcome_id[[k,74]] 
  n1 <- 0
  d=as.Date("2013-05-01")
  i=1
  while (dates_l >= "2013-05-01"){
    dates_l <- dates_l - 7
    d[i] = dates_l
    i = i+1
    n1 = n1+1
  }
  d[1:n1-1] # shows character(0) when the first week
  n1-1
  
  dates_l <- outcome_id[[k,74]] 
  n2=0
  e=as.Date("2013-09-30")
  j=1
  while (dates_l <= "2013-09-30"){
    dates_l <- dates_l + 7
    e[j]=dates_l
    j=j+1
    n2 = n2 + 1
  }
  e[1:n2-1] # shows character(0) when the last week
  n2-1
  
  # replicate covariates length of counterfactual dates
  # and make conuterfactual dates
  if (n1==1){
    cov_df <- do.call("bind_rows", replicate(n1+n2-1, outcome_id[k,],simplify = F))
    cov_df$dates <- c(outcome_id[[k,74]], e[1:n2-1])
  } else if (n2==1){
    cov_df <- do.call("bind_rows", replicate(n1+n2-1, outcome_id[k,],simplify = F))
    cov_df$dates <- c(outcome_id[[k,74]], d[1:(n1-1)])
  }else{
    cov_df <- do.call("bind_rows", replicate(n1+n2-1, outcome_id[k,],simplify = F))
    cov_df$dates <- c(outcome_id[[k,74]], d[1:(n1-1)], e[1:n2-1])
  }
  
  # bind unique id and date of the year with covariates
  id_date <- bind_cols(cov_df)
  # iteration which binds rows of unique ids
  id_date_df <- bind_rows(id_date_df, id_date)
}

outcome_casecross <- id_date_df %>%
  mutate(outcome = ifelse(dates == as.Date(fromdate, "%m/%d/%Y"), 1, 0)) %>%
  arrange(id, dates) # order by id and date

outcome_casecross <- id_date_df %>%
  mutate(outcome = ifelse(dates == as.Date(fromdate, "%m/%d/%Y"), 1, 0)) %>%
  arrange(personkey, dates) # order by id and date

write_path2 <- paste0("../../../data/data_new/oregon_ndc_casecrossover.csv")
write_csv(outcome_casecross, write_path2)

```

To get the time stratified data set, I create the lag variables that take smoke values from the previous days for zip codes, join the zipcode level populatoin-weighted pm to the data set, and create age, sex, month and season index.


```{r time stratified, eval=FALSE, echo=FALSE}
### Time stratified ------------------------------------------------------------
# read in zipcode level populatoin-weighted pm
read_path5 <- paste0('C:/Users/jyliu/Desktop/local_git_repo/oregon_wildfire_new/data/Oregon_PM/zip_pm_to_merge_with_acap.csv')

zip_smoke <- read_csv(read_path5) # 63801 rows

# descriptives of the two smoke datasets
summary(zip_smoke)

# Zipcode PM2.5 estimates
# create lag variables that take smoke values from n previous days for zipcodes
zip_smoke_w_lag <- zip_smoke %>% arrange(ZIPCODE, date) %>%
  # group by zipcode
  group_by(ZIPCODE) %>% 
  # wrf
  mutate(wrf_f_pm_lag1 = lag(wrf_f_pm, 1, order_by = ZIPCODE), 
         wrf_f_pm_lag2 = lag(wrf_f_pm, 2, order_by = ZIPCODE),
         wrf_f_pm_lag3 = lag(wrf_f_pm, 3, order_by = ZIPCODE),
         wrf_f_pm_lag4 = lag(wrf_f_pm, 4, order_by = ZIPCODE),
         wrf_f_pm_lag5 = lag(wrf_f_pm, 5, order_by = ZIPCODE),
         # wrf no fire lag
         wrf_nf_pm_lag1 = lag(wrf_nf_pm, 1, order_by = ZIPCODE),
         wrf_nf_pm_lag2 = lag(wrf_nf_pm, 2, order_by = ZIPCODE),
         wrf_nf_pm_lag3 = lag(wrf_nf_pm, 3, order_by = ZIPCODE),
         wrf_nf_pm_lag4 = lag(wrf_nf_pm, 4, order_by = ZIPCODE),
         wrf_nf_pm_lag5 = lag(wrf_nf_pm, 5, order_by = ZIPCODE),
         # wrf_smk_pm
         wrf_smk_pm_lag1 = lag(wrf_smk_pm, 1, order_by = ZIPCODE),
         wrf_smk_pm_lag2 = lag(wrf_smk_pm, 2, order_by = ZIPCODE),
         wrf_smk_pm_lag3 = lag(wrf_smk_pm, 3, order_by = ZIPCODE),
         wrf_smk_pm_lag4 = lag(wrf_smk_pm, 4, order_by = ZIPCODE),
         wrf_smk_pm_lag5 = lag(wrf_smk_pm, 5, order_by = ZIPCODE),
         # geo weighted pm
         geo_wt_pm_lag1 = lag(geo_wt_pm, 1, order_by = ZIPCODE),
         geo_wt_pm_lag2 = lag(geo_wt_pm, 2, order_by = ZIPCODE),
         geo_wt_pm_lag3 = lag(geo_wt_pm, 3, order_by = ZIPCODE),
         geo_wt_pm_lag4 = lag(geo_wt_pm, 4, order_by = ZIPCODE),
         geo_wt_pm_lag5 = lag(geo_wt_pm, 5, order_by = ZIPCODE),
         # krig pm
         krig_pm_lag1 = lag(krig_pm, 1, order_by = ZIPCODE),
         krig_pm_lag2 = lag(krig_pm, 2, order_by = ZIPCODE),
         krig_pm_lag3 = lag(krig_pm, 3, order_by = ZIPCODE),
         krig_pm_lag4 = lag(krig_pm, 4, order_by = ZIPCODE),
         krig_pm_lag5 = lag(krig_pm, 5, order_by = ZIPCODE),   
         # background pm
         background_pm_lag1 = lag(background_pm, 1, order_by = ZIPCODE),
         background_pm_lag2 = lag(background_pm, 2, order_by = ZIPCODE),
         background_pm_lag3 = lag(background_pm, 3, order_by = ZIPCODE),
         background_pm_lag4 = lag(background_pm, 4, order_by = ZIPCODE),
         background_pm_lag5 = lag(background_pm, 5, order_by = ZIPCODE),   
         # geo_smk_pm 
         geo_smk_pm_lag1 = lag(geo_smk_pm, 1, order_by = ZIPCODE),
         geo_smk_pm_lag2 = lag(geo_smk_pm, 2, order_by = ZIPCODE),
         geo_smk_pm_lag3 = lag(geo_smk_pm, 3, order_by = ZIPCODE),
         geo_smk_pm_lag4 = lag(geo_smk_pm, 4, order_by = ZIPCODE),
         geo_smk_pm_lag5 = lag(geo_smk_pm, 5, order_by = ZIPCODE),
         # krig smk pm
         krig_smk_pm_lag1 = lag(krig_smk_pm, 1, order_by = ZIPCODE),
         krig_smk_pm_lag2 = lag(krig_smk_pm, 2, order_by = ZIPCODE),
         krig_smk_pm_lag3 = lag(krig_smk_pm, 3, order_by = ZIPCODE),
         krig_smk_pm_lag4 = lag(krig_smk_pm, 4, order_by = ZIPCODE),
         krig_smk_pm_lag5 = lag(krig_smk_pm, 5, order_by = ZIPCODE),
         # temp
         wrf_temp_lag1 = lag(wrf_temp, 1, order_by = ZIPCODE),
         wrf_temp_lag2 = lag(wrf_temp, 2, order_by = ZIPCODE),
         wrf_temp_lag3 = lag(wrf_temp, 3, order_by = ZIPCODE),
         wrf_temp_lag4 = lag(wrf_temp, 4, order_by = ZIPCODE),
         wrf_temp_lag5 = lag(wrf_temp, 5, order_by = ZIPCODE)) %>% 
  # ungroup by zip
  ungroup(ZIPCODE) %>% 
  # attach a zip indicator for each smoke variable
  setNames(paste(colnames(.), "zip", sep="_")) %>% 
  # remove the '_zip' from the zipcode and date variable 
  rename(ZIPCODE = ZIPCODE_zip, date = date_zip)


read_path4 <- paste0("../data_new/medication/oregon_ndc_casecrossover.csv")
# read_path4 <- paste0("../../../data/data_new/oregon_ndc_casecrossover.csv") # for server
or_disease <- read_csv(read_path4)

### try join
colnames(or_disease)[24] <- c("ZIPCODE")
colnames(or_disease)[74] <- c("date")

outcome_casecross <- or_disease %>%
  # indicator for male=0, female=1, unknown = 2
  mutate(age = 2013-yob,
         sex_ind =ifelse(gender == "F", 1, 
                         ifelse(gender == "M", 0, 2)),
         age_ind = ifelse(age < 15, 0,
                          ifelse(age >= 15 & age < 65, 1,
                                 ifelse(age >= 65 & age <=105, 2, NA)))
  ) %>% # end of mutate 
  # create variables
  mutate(day = as.factor(weekdays(fromdate)),
         day_admit = as.factor(weekdays(date)),
         month_smk = month(fromdate),
         month_admit = month(date),
         season_smk = ifelse(fromdate >= "2013-03-20" &  
                               fromdate <= "2013-06-21", "spring",
                             ifelse(fromdate >= "2013-06-22" &  
                                      fromdate <= "2013-09-22", "summer",
                                    ifelse(fromdate >= "2013-09-23" & 
                                             fromdate <= "2013-12-21", "fall", "other"))),
         season_admit = ifelse(date >= "2013-03-20" &  
                                 date <= "2013-06-21", "spring",
                               ifelse(date >= "2013-06-22" &  
                                        date <= "2013-09-22", "summer",
                                      ifelse(date >= "2013-09-23" & 
                                               date <= "2013-12-21", "fall", "other")))) %>%
  # join with zip-level pm estimates
  left_join(zip_smoke_w_lag, by = c("date", "ZIPCODE"))%>%
  arrange(personkey, fromdate) # order by id and fromdate

write_path4 <- paste0("../data_new/medication/oregon_ndc_time_strat_casecrossover.csv")
write_csv(outcome_casecross, write_path4)

```


### Descriptives

For all of 2013, there were a total of millons of all claims records in the APAC dataset. During the May 1st to September 30th wildfire season in Oregon state, there were 24217 pharmacy visits for the ndc of beta 2 agonists. The number of cases, as well as age-specific and sex-specific strate are shown below.


```{r descriptive table, echo = F, message = F, warning = F, results='asis'}
read_path6 <- paste0("../data_new/medication/oregon_ndc_time_strat_casecrossover.csv")
asthma_ndc <- read_csv(read_path6)

# dataframe list
method_list <- c('WRF-Chem Smoke', 'Geo-Weighted Smoke', 'Kriging Smoke')

# dataframe to loop through
asthma_ndc_df <- data.frame(asthma_ndc)

# outcome name
outcome_name <- "Inhalers"

# dataframe for analysis creation
# bind columns back together 
df_analysis <- asthma_ndc_df %>%
  filter(!is.na(wrf_smk_pm_zip)) %>% 
  # only look at outcomes
  filter(outcome == 1) %>%
  # add another row that makes sure there is a person <15 in the dataframe
  # tricking xtabs to produce a 0 cell for the outcome for age <15
  add_row(outcome = 0, age_ind = 0)
  
# cross tabs
outcome_n <- xtabs(~ outcome, df_analysis)
cross_tab_age <- xtabs(~ outcome + age_ind, df_analysis)
cross_tab_sex <- xtabs(~ outcome + sex_ind, df_analysis)
# empty matrix
point_estimates <- matrix(nrow = 1, ncol = 7, byrow = T)
  
colnames(point_estimates) <- c("outcome", "n", "age_15", "age_15_65", 
                               "age_65", "female", "male")
  
# fill in the outcome name for the dataframe before the loop
point_estimates[, 1] <- outcome_name
# fill n
point_estimates[, 2] <- outcome_n[2] # second element of the 1 dimension vector
# age <15
point_estimates[, 3] <- cross_tab_age[2, 1]
# age 15 to 65
point_estimates[, 4] <- cross_tab_age[2, 2]
# age >65
point_estimates[, 5] <- cross_tab_age[2, 3]
# male == 0
point_estimates[, 7] <- cross_tab_sex[1, 1]
# female == 1
point_estimates[, 6] <- cross_tab_sex[1, 2]


# save point estimates as a dataframe
point_est_df <- as_data_frame(point_estimates)
  
# combine each outcome dataframe itteration in to a big dataset
asthma_point_est_df <- point_est_df %>% 
  # find proportions/percents for each strata in a row
  mutate(age_15_pr = as.character(round((as.numeric(age_15)/as.numeric(n))*100,1)),
         age_15_65_pr = as.character(round((as.numeric(age_15_65)/as.numeric(n))*100,1)),
         age_65_pr = as.character(round((as.numeric(age_65)/as.numeric(n))*100,1)),
         female_pr = as.character(round((as.numeric(female)/as.numeric(n))*100,1)),
         male_pr = as.character(round((as.numeric(male)/as.numeric(n))*100,1))) %>% 
  select(outcome, n, age_15, age_15_pr, age_15_65, age_15_65_pr, age_65,
         age_65_pr, female, female_pr, male, male_pr)

# str(asthma_point_est_df)
  
tab <- htmlTable(txtRound(asthma_point_est_df, digits = 1), 
           caption = "Number of cases for each outcome observed from May 1st to September 30st, 2013",
           # column headers
           header = c("Outcome", "Cases n", "Less than 15", "(%)", "15 to 65", "(%)", "Greater than 65",
                      "(%)", "Female", "(%)", "Male", "(%)"),
           # column spanner
           cgroup = c("","Age Category", "Sex"), 
           n.cgroup = c(2, 6, 4),
           padding.rgroup = "&nbsp;&nbsp;",
           css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
           align = "llccccc" # column alignment,
            ) # end table

print(tab)


```


### Overall plot


```{r overall, warning =F, echo = F, results='asis'} 
# dataframe list

method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Geo-Weighted Smoke')

# dataframe to loop through
asthma_ndc_df <- data.frame(asthma_ndc)

# outcome name
outcome <- "Asthma Inhalers"
outcome_name <- "Asthma Inhalers"

# data wrangling ----
# Producing conditional logit model estimates loop 

# extract covariates from dataframe
covariates_df <- asthma_ndc_df[, c(1:26, 74:84)]
  
# extract pm values and divide by 10 and ordered
#which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
pm_estimates_df <- asthma_ndc_df[, c(87, 92, 91, 93)]/10  # create 10 unit increases

# new loop for age categories

# empty matrix (12 x 10 matrix)
point_estimates <- matrix(nrow = 3, ncol = 9, byrow = T)
    
colnames(point_estimates) <- c('outcome', 'pm_method', 'n', 'n_events', 
                                   'odds_ratio', 'lower95', 'upper95', 'se', 'p_val')    
  
# fill in the outcome namedataframe before method loop
point_estimates[, 1] <- outcome_name

# dataframe for analysis creation
# bind columns back together 
df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
  # remove missing pm values
  filter(!is.na(wrf_smk_pm_zip)) %>% 
  # the following code makes sure that the counterfactual values retained are 
  # symetric in that number of obs before = number of obs after
  mutate(obs_diff_admission = (fromdate - date)/7) 
  # dataframe is already for the entire fire season, so I don't need to subset anymore
  
# second loop to run a model for each pm estimation method
for(j in 38:40){

  # variable to model 
  var_name <- colnames(df_analysis[j])
      
  # set row number to fill
  row_n <- j-37
      
  # only run the model if the dataframe has observations
  if(nrow(df_analysis) != 0){
  # conditional logistic regression model
  mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip + strata(personkey), df_analysis)
      
  # populate matrix
  point_estimates[row_n, 2] <- method_list[row_n]
  point_estimates[row_n, 3] <- mod$n
  point_estimates[row_n, 4] <- mod$nevent
  # odds ratio
  point_estimates[row_n, 5] <- round(exp(summary(mod)$coefficient[1,1]), 3)

  # 95% lower bound
  point_estimates[row_n, 6] <- round(exp((summary(mod)$coefficient[1,1]) -                                                                             1.96*(summary(mod)$coefficient[1,3])), 3)
  # 95% upper bound
  point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) +
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
  # standard error
  point_estimates[row_n, 8] <- round(summary(mod)$coefficient[1,3], 4)
  # p val
  point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,5], 4)
      
  # create else statement that fills matrix with missing so I still have the row
  # in the final dataframe
  } else {point_estimates[row_n, 2] <- method_list[row_n]
          point_estimates[row_n, 3] <- 0
          point_estimates[row_n, 4] <- 0
          point_estimates[row_n, c(5:9)] <- 99 } # end 'if else' statement
  } # end methods loop
  
# save point estimates as a dataframe
combined_point_est_df <- as_data_frame(point_estimates)



wrf_geo_age <- combined_point_est_df %>% 
  # filter columns to just geo-smk
  # filter(pm_method == "GWR Smoke" |
    #      pm_method == "WRF-Chem Smoke") %>% 
  # subset columns I want to put in to the table
  select(2, 4:7) %>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, "--", odds_ratio),
         lower95 = ifelse(lower95 == 99, "--", lower95),
         upper95 = ifelse(upper95 == 99, "--", upper95))


tab <- htmlTable(txtRound(wrf_geo_age, digits = 3, 1:3), 
         caption = "Association between a 10 ug/m^3 in PM2.5 three smoke method and pharmacy outcomes",
         # row group by outcome
         rgroup = "Asthma Inhalers",
         n.rgroup = c(rep(3, 1)), # 6 rows for each age cat for each outcome
         # column headers
         header = c("Est Method", "Events",
                    "OR&dagger;", "Lower", "Upper"),
         # column spanner
         cgroup = c("", "95% CI"), 
         n.cgroup = c(3, 2),
         padding.rgroup = "&nbsp;&nbsp;",
         css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
         align = "llcccc", # column alignment,
         tfoot="&dagger; Referent periods matched to events on same day of week within May to September fire season."
         ) # end table
  
print(tab)
  
combined_point_est_df_new <- combined_point_est_df %>%
  mutate(n_events_new = ifelse(as.numeric(n_events)>=100, n_events,
                        ifelse(as.numeric(n_events)<100, "0", NA))) %>%
  select(-n_events) %>%
  rename(n_events = n_events_new)


# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
wrf_geo_age_plot <- combined_point_est_df_new %>% 
  # filter columns to just geo-smk
 #  filter(pm_method == "GWR Smoke" | pm_method == "WRF-Chem Smoke") %>% 
  # do not plot results with less than 15 events, create missing vals
  # in mutate
  mutate(odds_ratio = ifelse(as.numeric(n_events) < 15, 
                             99, odds_ratio),
         lower95 = ifelse(as.numeric(n_events) < 15, 
                             99, lower95),
         upper95 = ifelse(as.numeric(n_events) < 15, 
                             99, upper95)) %>% 
  # subset columns I want to put in to the table
  select(1, 2, 9, 4:6) %>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, NA, odds_ratio),
         lower95 = ifelse(lower95 == 99, NA, lower95),
         upper95 = ifelse(upper95 == 99, NA, upper95))

# change characters to numeric and factor  
wrf_geo_age_plot$outcome <- factor(wrf_geo_age_plot$outcome,
                              levels = unique(wrf_geo_age_plot$outcome))

wrf_geo_age_plot$pm_method <- factor(wrf_geo_age_plot$pm_method,
                                levels = unique(wrf_geo_age_plot$pm_method))

wrf_geo_age_plot$n_events <- as.numeric(wrf_geo_age_plot$n_events)
wrf_geo_age_plot$odds_ratio <- as.numeric(wrf_geo_age_plot$odds_ratio)
wrf_geo_age_plot$lower95 <- as.numeric(wrf_geo_age_plot$lower95)
wrf_geo_age_plot$upper95 <- as.numeric(wrf_geo_age_plot$upper95)


## ggplot 
  print_plot <- ggplot(wrf_geo_age_plot,
    aes(x = pm_method, y = odds_ratio, color = pm_method), na.rm = T) +
    geom_point(position = position_dodge(width = 0.5), na.rm = T) + 
    geom_errorbar(aes(ymin=lower95, ymax=upper95), 
                  position = position_dodge(width = 0.5), width = 0.2, na.rm =T) +
    # custom color 
    scale_color_manual(name = "Smoke-Estimation Method", 
                       values = c("red",  "blue", "#32115C"),
                       guide = guide_legend(title.position = "top", title.hjust = 0.5)) +
    facet_wrap(~outcome, nrow = 3, scales = "free") +
    geom_hline(yintercept = 1, linetype=2) +
    #ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab(expression(paste("Odds Ratio for 10Âµg/m"^3, " Increase in PM"[2.5]))) +
    #ylim(0, 2) +
    xlab('Smoke Estimation Method') +
    # plot theme
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # strip element
    strip.background = element_rect(colour=NA, fill=NA),
    panel.border = element_rect(fill = NA, color = "black"),
    # facet text size
    strip.text = element_text(size = 10),
    # axis element
    #axis.text.x = element_blank(),
    #axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # legend elements
    legend.position = "bottom")
    #legend.text = element_text(size = 8))


  print(print_plot)
  # save figure
  ggsave("../plot_new/ndc_age_fig_three.pdf", plot = print_plot, 
       width = 12, height = 8, units = "in")
  
```



### Time-Stratified by Age Categories 

Following table and figure look at some outcomes stratified by age category. 

For some outcomes, such like Age > 65 in WRF-Chem method, the CI is the only insignificant one in the plot.


```{r time stratified age strata cdc met, warning =F, echo = F, results='asis'} 
# dataframe list

method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Geo-Weighted Smoke')

# dataframe to loop through
asthma_ndc_df <- data.frame(asthma_ndc)

# outcome name
outcome <- "asthma inhalers"
outcome_name <- "Asthma inhalers"

# age category list
age_cat_list <- c(0,1,2)

# create an empty list to row bind dataframes together
datalist1 <- list()


# data wrangling ----
# Producing conditional logit model estimates loop 

# extract covariates from dataframe
covariates_df <- asthma_ndc_df[, c(1:26, 74:84)]
  
# extract pm values and divide by 10 and ordered
#which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
pm_estimates_df <- asthma_ndc_df[, c(87, 92, 91, 93)]/10  # create 10 unit increases

# new loop for age categories
for(k in 0:2){
  # empty matrix (12 x 10 matrix)
  point_estimates <- matrix(nrow = 3, ncol = 10, byrow = T)
    
  colnames(point_estimates) <- c('outcome', 'age_cat', 'pm_method', 'n', 'n_events', 
                                   'odds_ratio', 'lower95', 'upper95', 'se', 'p_val')    
  
  # fill in the outcome namedataframe before method loop
  point_estimates[, 1] <- outcome_name
  # repeat the age category 4 times for each pm method
  point_estimates[, 2] <- k
    
  # dataframe for analysis creation
  # bind columns back together 
  df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
    # remove missing pm values
    filter(!is.na(wrf_smk_pm_zip)) %>% 
    # limit to specific age category
    filter(age_ind == k) %>% 
    # the following code makes sure that the counterfactual values retained are 
    # symetric in that number of obs before = number of obs after
    mutate(obs_diff_admission = (fromdate - date)/7) 
    # dataframe is already for the entire fire season, so I don't need to subset anymore
  
  # second loop to run a model for each pm estimation method
  for(j in 38:40){

    # variable to model 
    var_name <- colnames(df_analysis[j])
      
    # set row number to fill
    row_n <- j-37
      
    # only run the model if the dataframe has observations
    if(nrow(df_analysis) != 0){
    # conditional logistic regression model
    mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip + strata(personkey), df_analysis)
      
    # populate matrix
    point_estimates[row_n, 3] <- method_list[row_n]
    point_estimates[row_n, 4] <- mod$n
    point_estimates[row_n, 5] <- mod$nevent
    # odds ratio
    point_estimates[row_n, 6] <- round(exp(summary(mod)$coefficient[1,1]), 3)

    # 95% lower bound
    point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) -                                                                             1.96*(summary(mod)$coefficient[1,3])), 3)
    # 95% upper bound
    point_estimates[row_n, 8] <- round(exp((summary(mod)$coefficient[1,1]) +
                                        1.96*(summary(mod)$coefficient[1,3])), 3)
    # standard error
    point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,3], 4)
    # p val
    point_estimates[row_n, 10] <- round(summary(mod)$coefficient[1,5], 4)
      
    # create else statement that fills matrix with missing so I still have the row
    # in the final dataframe
    } else {point_estimates[row_n, 3] <- method_list[row_n]
            point_estimates[row_n, 4] <- 0
            point_estimates[row_n, 5] <- 0
            point_estimates[row_n, c(6:10)] <- 99 } # end 'if else' statement
    } # end methods loop
  
  # save point estimates as a dataframe
  point_est_df <- as_data_frame(point_estimates)
  datalist1[[k+1]] <- point_est_df
} # end age category loop

# bind rows of age category estimates together
combined_point_est_df <- bind_rows(datalist1)



wrf_geo_age <- combined_point_est_df %>% 
  # filter columns to just geo-smk
  # filter(pm_method == "GWR Smoke" |
    #      pm_method == "WRF-Chem Smoke") %>% 
  mutate(age_cat2 = ifelse(age_cat == 0, "Less than 15", 
                    ifelse(age_cat == 1, "15-65",
                    ifelse(age_cat == 2, "Greater than 65", NA)))) %>% 
  # subset columns I want to put in to the table
  select(3, 11, 5:8) %>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, "--", odds_ratio),
         lower95 = ifelse(lower95 == 99, "--", lower95),
         upper95 = ifelse(upper95 == 99, "--", upper95))


tab <- htmlTable(txtRound(wrf_geo_age, digits = 3, 1:3), 
         caption = "Association between a 10 ug/m^3 in PM2.5 geo smoke and health outcomes stratified by age",
         # row group by outcome
         rgroup = "Asthma inhalers",
         n.rgroup = c(rep(9, 1)), # 6 rows for each age cat for each outcome
         # column headers
         header = c("Est Method", "Age Group", "Events",
                    "OR&dagger;", "Lower", "Upper"),
         # column spanner
         cgroup = c("", "95% CI"), 
         n.cgroup = c(4, 2),
         padding.rgroup = "&nbsp;&nbsp;",
         css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
         align = "llcccc", # column alignment,
         tfoot="&dagger; Time-stratified: referent periods matched to events on same day of week within May to September fire season."
         ) # end table
  
print(tab)
  
combined_point_est_df_new <- combined_point_est_df %>%
  mutate(n_events_new = ifelse(as.numeric(n_events)>=100, n_events,
                        ifelse(as.numeric(n_events)<100, "0", NA))) %>%
  select(-n_events) %>%
  rename(n_events = n_events_new)


# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
wrf_geo_age_plot <- combined_point_est_df_new %>% 
  # filter columns to just geo-smk
 #  filter(pm_method == "GWR Smoke" | pm_method == "WRF-Chem Smoke") %>% 
  # do not plot results with less than 15 events, create missing vals
  # in mutate
  mutate(odds_ratio = ifelse(as.numeric(n_events) < 15, 
                             99, odds_ratio),
         lower95 = ifelse(as.numeric(n_events) < 15, 
                             99, lower95),
         upper95 = ifelse(as.numeric(n_events) < 15, 
                             99, upper95),
         age_cat2 = ifelse(age_cat == 0, "<15", 
                    ifelse(age_cat == 1, "15-65",
                    ifelse(age_cat == 2, ">65", NA)))) %>% 
  # subset columns I want to put in to the table
  select(1, 3, 11, 10, 5:7) %>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, NA, odds_ratio),
         lower95 = ifelse(lower95 == 99, NA, lower95),
         upper95 = ifelse(upper95 == 99, NA, upper95))

# change characters to numeric and factor  
wrf_geo_age_plot$outcome <- factor(wrf_geo_age_plot$outcome,
                              levels = unique(wrf_geo_age_plot$outcome))

wrf_geo_age_plot$pm_method <- factor(wrf_geo_age_plot$pm_method,
                                levels = unique(wrf_geo_age_plot$pm_method))

wrf_geo_age_plot$age_cat2 <- factor(wrf_geo_age_plot$age_cat2,
                                levels = unique(wrf_geo_age_plot$age_cat2))

wrf_geo_age_plot$n_events <- as.numeric(wrf_geo_age_plot$n_events)
wrf_geo_age_plot$odds_ratio <- as.numeric(wrf_geo_age_plot$odds_ratio)
wrf_geo_age_plot$lower95 <- as.numeric(wrf_geo_age_plot$lower95)
wrf_geo_age_plot$upper95 <- as.numeric(wrf_geo_age_plot$upper95)


## ggplot 
  print_plot <- ggplot(wrf_geo_age_plot,
    aes(x = age_cat2, y = odds_ratio, color = pm_method), na.rm = T) +
    geom_point(position = position_dodge(width = 0.5), na.rm = T) + 
    geom_errorbar(aes(ymin=lower95, ymax=upper95), 
                  position = position_dodge(width = 0.5), width = 0.2, na.rm =T) +
    # custom color 
    scale_color_manual(name = "Smoke-Estimation Method", 
                       values = c("red",  "blue", "#32115C"),
                       guide = guide_legend(title.position = "top", title.hjust = 0.5)) +
    facet_wrap(~outcome, nrow = 3, scales = "free") +
    geom_hline(yintercept = 1, linetype=2) +
    #ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab(expression(paste("Odds Ratio for 10Âµg/m"^3, " Increase in PM"[2.5]))) +
    #ylim(0, 2) +
    xlab('Age Category ') +
    # plot theme
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # strip element
    strip.background = element_rect(colour=NA, fill=NA),
    panel.border = element_rect(fill = NA, color = "black"),
    # facet text size
    strip.text = element_text(size = 10), 
    # axis element
    #axis.text.x = element_blank(),
    #axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # legend elements
    legend.position = "bottom")
    #legend.text = element_text(size = 8))


  print(print_plot)
  # save figure
  ggsave("../plot_new/ndc_age_fig_three.pdf", plot = print_plot, 
       width = 12, height = 8, units = "in")
  
```


### Seasonal Time-Stratified by Sex

Association with smoke PM~2.5~ and health outcomes stratified by sex. 

All the CI do not include 1, which means the use of asthma medication (beta 2 agonists) increases about 5% when smoke increase 10 units. So the risk for getting asthma will increase about 5% ~ 8% when the smoke PM2.5 increase 10 units.

```{r sex strata cdc met adj, warning = F, echo = F, results='asis'} 
method_list <- c('WRF-Chem Smoke', 'Kriging Smoke', 'Geo-Weighted Smoke')

# dataframe to loop through
asthma_ndc_df <- data.frame(asthma_ndc)

# outcome name
outcome <- "asthma inhalers"
outcome_name <- "Asthma inhalers"

# create an empty list to row bind dataframes together
datalist1 <- list()

# sex category list
sex_strata_list <- c(0,1)

# data wrangling ----
# Producing conditional logit model estimates loop 

# extract covariates from dataframe
covariates_df <- asthma_ndc_df[, c(1:26, 74:84)]
  
# extract pm values and divide by 10 and ordered
#which(colnames(df_to_loop)=="global_smk_pm_zip") # code to find column numbers
pm_estimates_df <- asthma_ndc_df[, c(87, 92, 91, 93)]/10  # create 10 unit increases


# new loop for sex categories
for(k in 0:1){
 
  # empty matrix (12 x 10 matrix)
  point_estimates <- matrix(nrow = 3, ncol = 10, byrow = T)
    
  colnames(point_estimates) <- c('outcome', 'sex', 'pm_method', 'n', 'n_events', 
                                   'odds_ratio', 'lower95', 'upper95', 'se', 'p_val')
    
  # fill in the outcome namedataframe before method loop
  point_estimates[, 1] <- outcome_name
  # repeat the sex category 4 times for each pm method
  point_estimates[, 2] <- k
    
    
  # dataframe for analysis creation
  # bind columns back together 
  df_analysis <- cbind(covariates_df, pm_estimates_df) %>% 
    # remove missing pm values
    filter(!is.na(wrf_smk_pm_zip)) %>% 
    # limit to specific sex category
    filter(sex_ind == k) %>% 
    # the following code makes sure that the counterfactual values retained are 
    # symetric in that number of obs before = number of obs after
    mutate(obs_diff_admission = (fromdate - date)/7) 
    # dataframe is already for the entire fire season, so I don't need to subset anymore
  
  # second loop to run a model for each pm estimation method
  for(j in 38:40){

    # variable to model 
    var_name <- colnames(df_analysis[j])
      
    # set row number to fill
    row_n <- j-37
      
    # only run the model if the dataframe has observations
    if(nrow(df_analysis) != 0){
    # conditional logistic regression model
    mod <- clogit(outcome ~ df_analysis[[j]] + wrf_temp_zip + strata(personkey), df_analysis)
      
    # populate matrix
    point_estimates[row_n, 3] <- method_list[row_n]
    point_estimates[row_n, 4] <- mod$n
    point_estimates[row_n, 5] <- mod$nevent
    # odds ratio
    point_estimates[row_n, 6] <- round(exp(summary(mod)$coefficient[1,1]), 3)

    # 95% lower bound
    point_estimates[row_n, 7] <- round(exp((summary(mod)$coefficient[1,1]) -
                                      1.96*(summary(mod)$coefficient[1,3])), 3)
    # 95% upper bound
    point_estimates[row_n, 8] <- round(exp((summary(mod)$coefficient[1,1]) +
                                      1.96*(summary(mod)$coefficient[1,3])), 3)
    # standard error
    point_estimates[row_n, 9] <- round(summary(mod)$coefficient[1,3], 4)
    # p val
    point_estimates[row_n, 10] <- round(summary(mod)$coefficient[1,5], 4)
      
    # create else statement that fills matrix with missing so I still have the row
    # in the final dataframe
    } else {point_estimates[row_n, 3] <- method_list[row_n]
            point_estimates[row_n, 4] <- 0
            point_estimates[row_n, 5] <- 0
            point_estimates[row_n, c(6:10)] <- 99 } # end 'if else' statement
    } # end methods loop
  
  # save point estimates as a dataframe
  point_est_df <- as_data_frame(point_estimates)
    
  # combine previous values in dataframe that has all outcome/methods comparisons
  datalist1[[k+1]] <- point_est_df
} # end sex category loop

# bind rows of sex category estimates together
combined_point_est_df <- bind_rows(datalist1)



wrf_geo_sex <- combined_point_est_df %>% 
  # filter columns to just geo-smk
  # filter(pm_method == "GWR Smoke" | pm_method == "WRF-Chem Smoke") %>% 
  mutate(sex_cat = ifelse(sex == 0, "Male", 
               ifelse(sex == 1, "Female", NA))) %>% 
  # subset columns I want to put in to the table
  select(3, 11, 5:8)%>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, "--", odds_ratio),
         lower95 = ifelse(lower95 == 99, "--", lower95),
         upper95 = ifelse(upper95 == 99, "--", upper95))


  tab <- htmlTable(txtRound(wrf_geo_sex, digits = 3, 1:3), 
           caption = "Association between a 10 ug/m^3 in PM2.5 geo smoke and pharmacy outcomes stratified by sex",
           # row group by outcome
           rgroup = "Asthma inhalers",
           n.rgroup = c(rep(6, 1)), # 2 rows for each sex strata for each outcome
           # column headers
           header = c("Est Method", "Sex Strata", "Events",
                      "OR&dagger;", "Lower", "Upper"),
           # column spanner
           cgroup = c("", "95% CI"), 
           n.cgroup = c(4, 2),
           padding.rgroup = "&nbsp;&nbsp;",
           css.cell = "padding-left: 0.5em; padding-right: .5em;", # cell space
           align = "llcccc", # column alignment,
           tfoot="&dagger; Time-stratified: referent periods matched to events on same day of week within July to October fire season."
            ) # end table
  
  print(tab)
 
# ggplot of odds ratios, facet wrapped by outcomes -----
# convert variables from character to either numeric or factor
# factor preserves the order of the variable
wrf_geo_sex_plot <- combined_point_est_df %>% 
  # filter columns to just geo-smk
 #  filter(pm_method == "GWR Smoke" | 
   #       pm_method == "WRF-Chem Smoke") %>% 
  mutate(sex_cat = ifelse(sex == 0, "Male", 
               ifelse(sex == 1, "Female", NA))) %>%
  # subset columns I want to put in to the table
  select(1, 3, 11, 5:8) %>% 
  mutate(odds_ratio = ifelse(odds_ratio == 99, NA, odds_ratio),
         lower95 = ifelse(lower95 == 99, NA, lower95),
         upper95 = ifelse(upper95 == 99, NA, upper95))  

# change characters to numeric and factor  
wrf_geo_sex_plot$outcome <- factor(wrf_geo_sex_plot$outcome,
                              levels = unique(wrf_geo_sex_plot$outcome))

wrf_geo_sex_plot$pm_method <- factor(wrf_geo_sex_plot$pm_method,
                                levels = unique(wrf_geo_sex_plot$pm_method))

wrf_geo_sex_plot$sex_cat <- factor(wrf_geo_sex_plot$sex_cat,
                                levels = unique(wrf_geo_sex_plot$sex_cat))

wrf_geo_sex_plot$n_events <- as.numeric(wrf_geo_sex_plot$n_events)
wrf_geo_sex_plot$odds_ratio <- as.numeric(wrf_geo_sex_plot$odds_ratio)
wrf_geo_sex_plot$lower95 <- as.numeric(wrf_geo_sex_plot$lower95)
wrf_geo_sex_plot$upper95 <- as.numeric(wrf_geo_sex_plot$upper95)


## ggplot
  print_plot <- ggplot(wrf_geo_sex_plot,
    aes(x = sex_cat, y = odds_ratio, color = pm_method), na.rm = T) +
    geom_point(position = position_dodge(width = 0.5), na.rm = T) + 
    geom_errorbar(aes(ymin=lower95, ymax=upper95), 
                  position = position_dodge(width = 0.5), width = 0.2, na.rm =T) +
    # custom color 
    scale_color_manual(name = "Smoke-Estimation Method", 
                       values = c("red", "blue", "#32115C"),
                       guide = guide_legend(title.position = "top", title.hjust = 0.5)) +
    facet_wrap(~outcome, nrow = 3, scales = "free") +
    geom_hline(yintercept = 1, linetype=2) +
    #ggtitle('Association Between PM2.5 from \n Wildfire Smoke on Hospitalizations') +
    ylab(expression(paste("Odds Ratio for 10Âµg/m"^3, " Increase in PM"[2.5]))) +
    #ylim(0, 2) +
    xlab('Sex') +
    # plot theme
    theme(panel.background = element_rect(fill = 'white', colour = 'black'),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # strip element
    strip.background = element_rect(colour=NA, fill=NA),
    panel.border = element_rect(fill = NA, color = "black"),
    # facet text size
    strip.text = element_text(size = 10),
    # axis element
    #axis.text.x = element_blank(),
    #axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.y = element_text(angle = 90),
    # legend elements
    legend.position = "bottom")
    #legend.text = element_text(size = 8))


  print(print_plot)
  # save figure
  ggsave("../plot_new/ndc_sex_fig_three.pdf", plot = print_plot, 
       width = 12, height = 8, units = "in")


```


## County-level time series

### Overall pharmacy visit time series

The time series for the number of pharmacy in each day and separated with different counties. For convenience and representativeness, I choose some of the largest counties to show the visit features.

The overall time series plot shows a time series plot.


```{r time series, warning=FALSE, message=FALSE, echo=FALSE}
read_path7 <- paste0("../data_new/medication/oregon_asthma_ndc.csv")
or_ndc_claim <- read_csv(read_path7)

or_ndc_asthma <- or_ndc_claim %>%
  select(personkey, num_visit, clmid, line, ZIP, dates) 

# Join data with names of Oregon counties 
oregon_fips <- read_csv('../instructions/oregon_FIPS.csv')
# remove the "County" character
# factor(oregon_fips$county)
oregon_fips$county <- gsub(" County", "", as.character(factor(oregon_fips$county)))

oregon_fips <- oregon_fips %>%
  mutate(st_county_fips = with(oregon_fips, paste0(st_code, fips)))

### Join county with zip
read_path <- paste0('../data_new/update/or_zip_county_prop.csv') 
or_zip_county <- read_csv(read_path)

or_zip_county <- or_zip_county %>%
  select(zip, county_name) %>%
  rename(county = county_name) %>%
  rename(ZIP = zip) %>%
  full_join(oregon_fips, by = "county") %>%
  select(ZIP, county, state, st_county_fips) %>%
  rename(fips = st_county_fips)

or_zip_county$county[which(or_zip_county$county=="Hood.River")] <- "Hood River"

# Import population weighted county PM2.5
pm_path <- paste0("../data_new/county_data/or_county_pop_wt_pm.csv")
county_pm <- read_csv(pm_path)

# create a working dataset 'or_2013'
or_ndc_county_time_series <- or_ndc_asthma %>% 
  # join in the washington county name based on CHARS county identifier
  left_join(or_zip_county, by = "ZIP") %>% 
  # rename 'admit_date_impute' to 'date'
  rename(date = dates) %>%
  # rename(date = admit_date_impute) %>% 
  # group by county of residence and date
  group_by(county, date) %>% 
  # sum up each primary diagnosis for each outcome for each day for each county
  summarise(n_obs = n()) %>% 
  # join daily county estimates of pm2.5
  left_join(county_pm, by = c('date', 'county'))

# which(is.na(or_ndc_county_time_series$county))
# or_ndc_county_time_series[113,]
# which(or_zip_county$ZIP=="97078")

# summary(or_ndc_asthma)
# summary(or_ndc_county_time_series)
# summary(as.factor(or_ndc_county_time_series$county)) # 125 is missing out of 3592 (3.16%)

# remove NA values
# which(is.na(or_ndc_county_time_series$county)) # 3468-3592
or_ndc_county_time_series <- or_ndc_county_time_series[-c(3468:3592),]

# write permanent dataframe

write_path5 <- paste0("../data_new/medication/or_ndc_county_time_series.csv")
write_csv(or_ndc_county_time_series, write_path5)

## Check for missing values in sparsely populated counties. set to 0 (But no)
# check_missing <- filter(or_ndc_county_time_series, is.na(n_obs))
# mutate each to fill in missing values (Still no)
# check2 <- check_missing %>% mutate_each(funs(new = ifelse(is.na(.), 0, .)), 
#                                         n_obs:wrf_temp)

plot_ts <- ggplot(or_ndc_county_time_series, aes(y =n_obs, x = date)) +
           geom_jitter()

print(plot_ts)
# save figure
ggsave("../plot_new/ndc_ts.pdf", plot = plot_ts, 
       width = 12, height = 8, units = "in")
```

### County time series

The dotted time series plot of pharmacy visits by counties shows a large and distinct strata dotted time series in some big counties (such as Multnomah), I guess it may be the difference of visits between weekday and weekend. The lined time series plot also shows fluctuation. So we choose some larger counties (with more visits) to research on the effect of weekend and weekay.


```{r, warning=FALSE, message=FALSE,echo=FALSE}

plot_county <- ggplot(or_ndc_county_time_series, aes(y =n_obs, x = date)) +
               geom_jitter() + facet_wrap(~county)


plot_county_line <- ggplot(or_ndc_county_time_series, aes(y =n_obs, x = date)) +
                    facet_wrap(~county) + geom_line()

print(plot_county)
print(plot_county_line)
# save figure
ggsave("../plot_new/ndc_county_ts.pdf", plot = plot_county, 
       width = 12, height = 8, units = "in")
ggsave("../plot_new/ndc_county_ts_line.pdf", plot = plot_county_line, 
       width = 12, height = 8, units = "in")


```

### Time series of weekday and weekend in larger counties.
We check the time series for Multnomah, and it indeed shows more visits of weekdays than that in weekends (except some holidays such like Labor Day, Independent Day, etc.) We may choose the new covariates for weekday and weekend. 


```{r echo = FALSE, message=FALSE, warning=FALSE}
or_ndc_county_time_series_week <- or_ndc_county_time_series%>%
  mutate(day_admit = as.factor(weekdays(date)),
         month_admit = month(date)) %>%
  mutate(outcome = 1)

# Also check for Multnomah
multnomah_df <- or_ndc_county_time_series_week %>%
  filter(county == "Multnomah")

plot_mult_week <- ggplot(multnomah_df, aes(y =n_obs, x = date)) +
           geom_jitter() + facet_wrap(~day_admit)

print(plot_mult_week)

ggsave("../plot_new/multnomah_ts_week.pdf", plot = plot_mult_week, 
       width = 12, height = 8, units = "in")
```

### Time series of smoke exposure
The plot shows the times series of smoke PM 2.5 exposure. It seems that at the beginning of August or at the end of July the smoke has a peak. Also during the August the smoke is very high. The green one shows the WRF-Chem method; The bule one shows the Krigging method; And the red one, which we focus on, shows the GWR method.

```{r echo = FALSE, message=FALSE, warning=FALSE}

plot_smoke_ts_wrf <- ggplot(or_ndc_county_time_series_week, aes(y =wrf_smk_pm, x = date)) +
           geom_jitter(color="red")
# print(plot_smoke_ts_wrf)

plot_smoke_ts_krig <- ggplot(or_ndc_county_time_series_week, aes(y =krig_smk_pm, x = date)) +
           geom_jitter() 
# print(plot_smoke_ts_krig)

plot_smoke_ts_gwr <- ggplot(or_ndc_county_time_series_week, aes(y =geo_smk_pm, x = date)) +
           geom_jitter() 
# print(plot_smoke_ts_gwr)

plot_smk <- ggplot(or_ndc_county_time_series_week, aes(x = date)) +
  geom_jitter(aes(y =wrf_smk_pm, x = date), color='green', size = 1) + 
  geom_jitter(aes(y =krig_smk_pm, x = date), color='blue', size = 1) + 
  geom_jitter(aes(y =geo_smk_pm, x = date), color="red", size = 1)  +
  ylab("Smoke PM 2.5") 
 
  
print(plot_smk)


     
```




